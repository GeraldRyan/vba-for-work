Option Explicit

Sub Macro1()
'
' Macro1 Macro
'
' declare variables
Dim mycount As Integer
mycount = 0
Dim i As Integer
Dim First As range
Set First = range("A2")
Dim LastCell As range
Set LastCell = ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell)
Dim ClientName As String
ClientName = range("C10").FormulaR1C1
Dim BillPeriod As String
BillPeriod = Right(range("A4").FormulaR1C1, Len(range("A4").FormulaR1C1) - 5)


'make sure pivot table doesn't exist
If WorksheetExists("PivotTable") Then
Exit Sub
End If

Application.ScreenUpdating = False

' delete easy first Rs and Cs
range("A1:A5").EntireRow.Delete
range("B:D,G:H").Delete

' prepare loops
Set LastCell = LastCell.End(xlToLeft)
Set LastCell = LastCell.End(xlToLeft)
Set LastCell = LastCell.End(xlToLeft)
Set First = range("A2")
mycount = range(First, LastCell).Cells.Count
First.Select
'GoTo tempstart

For i = 1 To mycount
' get names aligned
If ActiveCell.Font.Bold = False And InStr(ActiveCell.Value, "(") <> 0 And ActiveCell.Offset(0, 1) = "" Then
           
    'code for string to cut and paste
    ActiveCell.Cut
    
    ' deal with special case in Practice Management report formatting.
    'TODO make sure this is completely general - i.e. covers all cases
    If InStr(ActiveCell.Offset(3, 0).Value, "Office ") <> 0 Then
        ActiveCell.Offset(1).Select
    Else
        ActiveCell.Offset(2).Select
    End If
Repeater:
        ActiveSheet.Paste
        If ActiveCell.Offset(1, 1) <> "" Then
            ActiveCell.Copy
            ActiveCell.Offset(1, 0).Select
            GoTo Repeater
    
        Else
        ' code to move to next
            ActiveCell.Offset(1, 0).Select
        End If
Else
ActiveCell.Offset(1, 0).Select
End If

Next i

'go back to startcell
First.Select

tempstart:
For i = 1 To mycount
    If ActiveCell.Row > LastCell.Row Then
    GoTo NextIteration
    End If
    
    'delete unwanted rows
    If (ActiveCell = "" And ActiveCell.Offset(0, 1) = "") Or (ActiveCell.Font.Bold = True And InStr(ActiveCell.Value, "Totals") = 0) Then
Again:
        ActiveCell.EntireRow.Delete
        If (ActiveCell = "" And ActiveCell.Offset(0, 1) = "") Or (ActiveCell.Font.Bold = True And InStr(ActiveCell.Value, "Totals") = 0) Then
            GoTo Again
        End If
    End If
    ActiveCell.Offset(1).Select
NextIteration:
Next i
range("A1").Select
MakePivot
AddUsercells
'SaveWorkbook
mymessage

Application.ScreenUpdating = True
End Sub

Sub AddUsercells()
Dim FRowNum As Integer
Dim LRowNum As Integer
Dim MyArray(3) As String
Dim TimesToDo As Integer
MyArray(0) = "Budget"
MyArray(1) = "Prior Year"
MyArray(2) = "Budget to Actual"
MyArray(3) = "PY to CY"
Dim i As Integer

ActiveSheet.range("A1").Select
Selection.End(xlDown).End(xlDown).Select
LRowNum = ActiveCell.Row
Selection.End(xlUp).Select
FRowNum = ActiveCell.Row
TimesToDo = LRowNum - FRowNum - 2
ActiveCell.Offset(1, 1).Select
ActiveCell.End(xlToRight).Select
ActiveCell.Offset(0, 1).Select
For i = 0 To 3
    Selection.FormulaR1C1 = MyArray(i) ' "Budget"
    Selection.Font.Bold = True
    Selection.HorizontalAlignment = xlCenter
    ActiveCell.Offset(0, 1).Select
Next i

'shade yeller
ActiveCell.Offset(1, -4).Select
ActiveCell.range("A1:B" & CStr(TimesToDo)).Select
Selection.Interior.Color = 65535
ActiveCell.Offset(0, 2).Select

For i = 0 To TimesToDo
     ActiveCell.Formula = "=" & ActiveCell.Offset(0, -2).Address & "-" & ActiveCell.Offset(0, -3).Address
     ActiveCell.Offset(0, 1).Select
     ActiveCell.Formula = "=" & ActiveCell.Offset(0, -2).Address & "-" & ActiveCell.Offset(0, -4).Address
     ActiveCell.Offset(1, -1).range("A1").Select
Next i
Selection.Offset(-1, -2).Select
For i = 0 To 1
    ActiveCell.Formula = "=SUM(R[-" & CStr(TimesToDo) & "]C:R[-1]C)"
    ActiveCell.Offset(0, 1).range("A1").Select
Next i

End Sub

Sub mymessage()
MsgBox ("Have a nice day")

End Sub


Sub OpenTemplateWorkbook()
Dim path As String
path = "C:\Users\gcr\Documents\Clients\DSB\Elaine\WIP macro project\Root\T.xlsx"

Workbooks.Open (path)
range("A1").Select

End Sub

Function WorksheetExists(sName As String) As Boolean
    WorksheetExists = Evaluate("ISREF('" & sName & "'!A1)")
End Function


Sub MakePivot()

'' Code below from source https://excelchamps.com/blog/vba-to-create-pivot-table/
'' Copyright by them as template if they have any, else just credit where due

'Declare Variables
Dim PSheet As Worksheet
Dim DSheet As Worksheet
Dim PCache As PivotCache
Dim PTable As PivotTable
Dim PRange As range
Dim LastRow As Long
Dim LastCol As Long

'create new Worksheet
On Error Resume Next
Application.DisplayAlerts = False
Sheets.Add After:=ActiveSheet
ActiveSheet.Name = "PivotTable"
Application.DisplayAlerts = True
Set PSheet = Worksheets("PivotTable")
Set DSheet = Worksheets("Report")

'Define Data Range
LastRow = DSheet.Cells(Rows.Count, 1).End(xlUp).Row
LastCol = DSheet.Cells(1, Columns.Count).End(xlToLeft).Column
Set PRange = DSheet.Cells(1, 1).Resize(LastRow - 1, LastCol)

'Define Pivot Cache
Set PCache = ActiveWorkbook.PivotCaches.Create _
(SourceType:=xlDatabase, SourceData:=PRange). _
CreatePivotTable(TableDestination:=PSheet.Cells(5, 1), _
TableName:="TimeUsage")


'Insert Blank Pivot Table
Set PTable = PCache.CreatePivotTable _
(TableDestination:=PSheet.Cells(1, 1), TableName:="TimeUsage")


'Insert Row Fields
With ActiveSheet.PivotTables("TimeUsage").PivotFields("Service Description")
    .Orientation = xlRowField
    .Position = 1
End With

'Insert Column Fields
With ActiveSheet.PivotTables("TimeUsage").PivotFields("Employee Name (Number)")
    .Orientation = xlColumnField
    .Position = 1
End With

'Insert Data Field
With ActiveSheet.PivotTables("TimeUsage").PivotFields("Bill Hrs")
    .Orientation = xlDataField
    .Position = 1
    .Function = xlSum
    ''' TODO try toggling this to see what happens
    '.NumberFormat = "#,##0"
    .Name = "Sum of Bill Hours"
End With

'Format Pivot
'' TODO Figure out what it does and if is necessary
'TableActiveSheet.PivotTables("TimeUsage").ShowTableStyleRowStripes _
'= TrueActiveSheet.PivotTables("TimeUsage").TableStyle2 = "PivotStyleMedium9"
ActiveSheet.Cells.ColumnWidth = 9.8

End Sub

Sub SaveWorkbook()
ActiveWorkbook.Save
End Sub


Public Function MyDocsPath() As String
   
MyDocsPath = VBA.Environ$("USERPROFILE")
MsgBox (MyDocsPath)
   
End Function

